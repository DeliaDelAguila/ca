---
title: "CA - S4: CLV with R"
author: Josep Curto
date: 2018
output: 
  html_notebook: 
    fig_caption: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
---

# Previous steps

## Load packages

```{r}
# List of packages for session
.packages = c("readxl","ggplot2")

# Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])

# Load packages into session 
lapply(.packages, require, character.only=TRUE)
```

## Loading data

```{r}
# Load data into a dataframe
df <- read_excel("s4.xlsx", sheet = "Ex2")
df
```

# EDA

The starting point is always EDA (Exploratory Data Analysis).

## Statistics

We need to understand the main statistics:

```{r}
summary(df)
```

**Question: What can we observe from the summary?**

## Customer evolution

Creating a line chart will help to understand the customers:

```{r}
ggplot(df, aes(x = t, y = active)) +
  geom_line() + ylab("Customer") + 
  xlab("Period") + labs(title = "Active Customer Evolution")
```

## Retentio ratio evolution

It can help as well to undestand the retention.

```{r}
ggplot(df, aes(x = t, y = r)) +
  geom_line() + ylab("Customer") + 
  xlab("Period") + labs(title = "Retention Ratio Evolution")
```

# CLV

Now we can calculate the (historic) CLV. First we create the new column with CLV per period:

```{r}
df$CLV <- (df$p-df$c)*df$r/(1+df$i)^df$t
df
```

##  CLV evolution

Now we can create a chart:

```{r}
ggplot(df, aes(x = t, y = CLV)) + geom_line() +
ylab("CLV") + xlab("Period") + labs(title = "CLV Evolution")
```

**Question: What do we observe?**

# Final steps

Finally we can calculate the CLV value:

## CLV

```{r}
CLV <- apply(df, 2, sum)
CLV[7]
```

# Exercise

**Question: What happens if retention ratio has a constant value of 0.80?**